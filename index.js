// Import stylesheets and dependencies.
import './styles.css';

import angular from 'angular';

// Define controllers.
class AppCtrl {
  regexPattern = null;
  duration = '(N/A)';

  constructor() {
    this.setRegexPatternWithCharsPowerOf2Exponent(0);
  }

  setRegexPatternWithCharsPowerOf2Exponent(exponent) {
    this.regexPattern = '(a+)+'.repeat(2 ** exponent);
  }

  copyRegex() {
    try {
      // Escape spacial regular expression characters.
      const pattern = this.regexPattern.replace(
        /[-.?*+^$|\\\/(){}[\]]/g,
        '\\$&'
      );
      const regex = new RegExp(pattern);

      const start = performance.now();
      angular.copy(regex);
      const end = performance.now();

      this.duration = `${((end - start) / 1000).toFixed(2)} seconds`;
    } catch (err) {
      handleError(err);
    }
  }

  copyTextWithRegex() {
    try {
      // Escape spacial regular expression characters.
      const pattern = this.regexPattern.replace(
        /[-.?*+^$|\\\/(){}[\]]/g,
        '\\$&'
      );

      const start = performance.now();
      angular.copy(pattern);
      const end = performance.now();

      this.duration = `${((end - start) / 1000).toFixed(2)} seconds`;
    } catch (err) {
      handleError(err);
    }
  }

  copyObjectWithRegexText() {
    try {
      // Escape spacial regular expression characters.
      const pattern = this.regexPattern.replace(
        /[-.?*+^$|\\\/(){}[\]]/g,
        '\\$&'
      );

      const someObject = {
        text: pattern,
      };

      const start = performance.now();
      angular.copy(someObject);
      const end = performance.now();

      this.duration = `${((end - start) / 1000).toFixed(2)} seconds`;
    } catch (err) {
      handleError(err);
    }
  }

  handleError(err) {
    const isChromeBrowser = navigator.userAgent.includes('Chrome');
    const isTooMuchRecursionError =
      `${err}` === 'InternalError: too much recursion';

    let message = `The operation failed with the following error:\n\n    ${err}`;
    if (!isChromeBrowser && isTooMuchRecursionError) {
      message +=
        '\n\nTo avoid this error, it is recommended to run this test case in the Chrome browser.';
    }

    alert(message);
    console.error(err);

    this.duration = '(APP CRASHED)';
  }
}

// Define and configure the app.
angular.module('app', []).controller('AppCtrl', AppCtrl);
